rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // FUNCIONES DE UTILIDAD
    // ============================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isValidCode(code) {
      return code.keys().hasAll(['code', 'isValid', 'createdAt']) 
        && code.code is string 
        && code.isValid is bool
        && code.createdAt is timestamp;
    }
    
    // ============================================
    // REGLAS PARA CÓDIGOS QR
    // ============================================
    
    match /codes/{codeId} {
      // LECTURA: Permitir a usuarios autenticados (panel admin)
      // Y lectura pública solo de códigos válidos
      allow get: if isAuthenticated() || resource.data.isValid == true;
      
      // Permitir listar solo si está autenticado
      allow list: if isAuthenticated();
      
      // ESCRITURA: Solo usuarios autenticados (admin)
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    
    // ============================================
    // REGLAS PARA RESEÑAS (REVIEWS)
    // ============================================
    
    match /reviews/{reviewId} {
      // LECTURA: Permitir lectura pública de todas las reseñas
      allow get: if true;
      allow list: if true;
      
      // CREAR: Permitir con validación estricta
      allow create: if request.resource.data.keys().hasAll(['name', 'rating', 'comment', 'code', 'createdAt'])
                    && request.resource.data.name is string
                    && request.resource.data.name.size() > 0
                    && request.resource.data.name.size() <= 100
                    && request.resource.data.rating is number
                    && request.resource.data.rating >= 1
                    && request.resource.data.rating <= 5
                    && request.resource.data.comment is string
                    && request.resource.data.comment.size() >= 10
                    && request.resource.data.comment.size() <= 1000
                    && request.resource.data.code is string
                    && request.resource.data.createdAt is timestamp;
      
      // ACTUALIZAR/ELIMINAR: Solo administradores autenticados
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    
    // ============================================
    // REGLAS PARA ESTADÍSTICAS
    // ============================================
    
    match /stats/{statId} {
      // LECTURA: Permitir lectura pública
      allow get: if true;
      allow list: if request.query.limit <= 10;
      
      // ESCRITURA: Solo administradores autenticados
      allow write: if isAuthenticated();
    }
    
    // ============================================
    // REGLAS PARA PROYECTOS
    // ============================================
    
    match /projects/{projectId} {
      // LECTURA: Pública
      allow read: if true;
      
      // ESCRITURA: Solo administradores autenticados
      allow write: if isAuthenticated();
    }
    
    // ============================================
    // REGLAS PARA MENSAJES DE CONTACTO
    // ============================================
    
    match /contact_messages/{messageId} {
      // LECTURA: Solo administradores autenticados
      allow read: if isAuthenticated();
      
      // CREAR: Permitir con validación
      allow create: if request.resource.data.keys().hasAll(['name', 'email', 'message', 'createdAt'])
                    && request.resource.data.name is string
                    && request.resource.data.name.size() > 0
                    && request.resource.data.name.size() <= 100
                    && request.resource.data.email is string
                    && request.resource.data.email.matches('^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$')
                    && request.resource.data.message is string
                    && request.resource.data.message.size() > 10
                    && request.resource.data.message.size() <= 5000
                    && request.resource.data.createdAt is timestamp;
      
      // ACTUALIZAR/ELIMINAR: Solo administradores autenticados
      allow update, delete: if isAuthenticated();
    }
    
    // ============================================
    // REGLAS PARA LOGS DE AUDITORÍA (OPCIONAL)
    // ============================================
    
    match /audit_logs/{logId} {
      // Solo administradores autenticados
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // ============================================
    // REGLAS PARA USUARIOS (OPCIONAL)
    // ============================================
    
    match /users/{userId} {
      // Solo el propio usuario puede leer sus datos
      allow read: if isOwner(userId);
      
      // Solo el propio usuario puede escribir sus datos
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if false;
    }
    
    // ============================================
    // DENEGAR TODO LO DEMÁS
    // ============================================
    
    match /{document=**} {
      allow read, write: if false;
    }
  }
}